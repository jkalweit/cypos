<link rel="import" href="bower_components/polymer/polymer.html">



<polymer-element name="pos-app">
    <template>
        <style>
        </style>
        <input value="{{message}}" />
        <input value="{{message}}" />
    </template>
    <script>
        Polymer('pos-app', {
            ready: function() {
                var sync = new SyncDbPath('long1.message', this, 'message');
            }
        });
    </script>
</polymer-element>


<script>


    function PathHelper(){}
    PathHelper.prototype.getTarget = function(target, parts) {
        if (!parts.length) {
            console.log('Error: parts.length should be >= 1')
            return null;
        }

        //console.log('  getting target from parts: ' + JSON.stringify(parts));
        var currPart;
        for (var i = 0; i < parts.length - 1; i++) {
            currPart = parts[i];
            if (!target.hasOwnProperty(currPart)) // build path if doesn't exist
                target[currPart] = {};
            target = target[currPart];
        }

        return target;
    };
    PathHelper.prototype.setValue = function(obj, path, value) {
        var parts = path.split('.');
        var target = PathHelper.prototype.getTarget(obj, parts);
        if(target) {
            target[parts[parts.length - 1]] = value;
        } else {
            console.log('ERROR: target does not exist: ', path);
        }
    };



    function SyncDbPath(dbPath, modelObj, modelPath) {
        // objects are passed by reference so we can observe db and modify model
        this.dbPath = dbPath;
        this.modelObj = modelObj;
        this.modelPath = modelPath;

        this.dbPathParts = dbPath.split('.');
        this.dbTargetProperty = this.dbPathParts[this.dbPathParts.length-1];
        this.modelPathParts = modelPath.split('.');
        this.modelTargetProperty = this.modelPathParts[this.modelPathParts.length-1];
        this.modelTarget = PathHelper.prototype.getTarget(this.modelObj, this.modelPathParts);
        console.log('   observing modelPath: ', this.modelPath, this.modelTargetProperty);
        Object.observe(this.modelTarget, this.modelObserver.bind(this));

        document.addEventListener('dbchanged', function (e) {
            this.dbObj = e.detail;
            this.dbTarget = PathHelper.prototype.getTarget(this.dbObj, this.dbPathParts);
            this.modelTarget[this.modelTargetProperty] = this.dbTarget[this.dbTargetProperty];
            console.log('   observing dbPath: ', this.dbPath, ': ', JSON.stringify(this.dbTarget));
            Object.observe(this.dbTarget, this.dbObserver.bind(this));
        }.bind(this));

        this.cancelNextUpdate = false;
    }
    SyncDbPath.prototype.modelObserver = function (changes) {
        changes.forEach(function(change) {
            if(change.name === this.modelTargetProperty && typeof change.oldValue !== 'undefined') {
                if(this.cancelNextUpdate){
                    this.cancelNextUpdate = false;
                    console.log('       model update canceled: ', change.type, change.name, change.oldValue, change.object[change.name]);
                } else {
                    //console.log('   model changed: ', change.type, change.name, change.oldValue, change.object[change.name]);
                    syncDb.update(this.dbPath, change.object[change.name]); // should be same as this.modelTarget[this.modelTargetProperty]
                }

            }
        }.bind(this));
    };
    SyncDbPath.prototype.dbObserver = function (changes) {
        changes.forEach(function(change) {
            //console.log('   db changed: ', change.type, change.name, change.oldValue, change.object[change.name], this.dbTargetProperty);
            if(change.name === this.dbTargetProperty) { // && typeof change.oldValue !== 'undefined')
                this.cancelNextUpdate = true;
                this.modelTarget[this.modelTargetProperty] = change.object[change.name];
                console.log('   db changed: ', change.type, change.name, change.oldValue, change.object[change.name]);
            }
        }.bind(this));
    };







    function SyncDb() {
        this.syncId = this.makeGuid();
        this.socket = io();

        this.socket.on('init', function (id, db) {
            console.log('   init rcvd: ' + JSON.stringify(db));
            this.db = db;
            this.initialized = true;
            this.fireDbChanged();
        }.bind(this));

        this.socket.on('update', function (id, path, value) {
            console.log('   update rcvd: ', path, JSON.stringify(value));
            PathHelper.prototype.setValue(this.db, path, value);
        }.bind(this));

        this.socket.emit('init', this.syncId);
    }
    SyncDb.prototype.update = function (path, value) {
        this.socket.emit('update', this.syncId, path, value);
    };
    SyncDb.prototype.makeGuid = function () {
        function S4() {
            return (((1+Math.random())*0x10000)|0).toString(16).substring(1);
        }
        return (S4() + S4() + "-" + S4() + "-4" + S4().substr(0,3) + "-" + S4() + "-" + S4() + S4() + S4()).toLowerCase();
    };
    SyncDb.prototype.fireDbChanged = function () {
        console.log(' detail: ' + JSON.stringify(this.db));
        var event = new CustomEvent('dbchanged', { 'detail': this.db });
        document.dispatchEvent(event);
    }




    var syncDb = new SyncDb();


</script>